const logo = `
  <svg
    width="14"
    height="14"
    viewBox="0 0 14 14"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M4.66848 14C5.28732 14 5.88081 13.7542 6.3184 13.3166C6.75598 12.879 7.00182 12.2855 7.00182 11.6667V9.33333H4.66848C4.04965 9.33333 3.45615 9.57916 3.01857 10.0167C2.58098 10.4543 2.33515 11.0478 2.33515 11.6667C2.33515 12.2855 2.58098 12.879 3.01857 13.3166C3.45615 13.7542 4.04965 14 4.66848 14V14Z"
      fill="#0ACF83"
    />
    <path
      d="M2.33515 7.00001C2.33515 6.38117 2.58098 5.78767 3.01857 5.35009C3.45615 4.9125 4.04965 4.66667 4.66848 4.66667H7.00182V9.33334H4.66848C4.04965 9.33334 3.45615 9.08751 3.01857 8.64992C2.58098 8.21234 2.33515 7.61884 2.33515 7.00001V7.00001Z"
      fill="#A259FF"
    />
    <path
      d="M2.33515 2.33333C2.33515 1.71481 2.58073 1.12159 3.01792 0.684062C3.45512 0.246529 4.04814 0.000483221 4.66666 0L7 0V4.66667H4.66849C4.04965 4.66667 3.45615 4.42083 3.01857 3.98325C2.58098 3.54566 2.33515 2.95217 2.33515 2.33333V2.33333Z"
      fill="#F24E1E"
    />
    <path
      d="M7.00182 0H9.33516C9.95399 0 10.5475 0.245833 10.9851 0.683417C11.4227 1.121 11.6685 1.71449 11.6685 2.33333C11.6685 2.95217 11.4227 3.54566 10.9851 3.98325C10.5475 4.42083 9.95399 4.66667 9.33516 4.66667H7.00182V0Z"
      fill="#FF7262"
    />
    <path
      d="M11.6685 7.00001C11.6685 7.61884 11.4227 8.21234 10.9851 8.64992C10.5475 9.08751 9.95399 9.33334 9.33516 9.33334C8.71632 9.33334 8.12283 9.08751 7.68524 8.64992C7.24766 8.21234 7.00182 7.61884 7.00182 7.00001C7.00182 6.38117 7.24766 5.78767 7.68524 5.35009C8.12283 4.9125 8.71632 4.66667 9.33516 4.66667C9.95399 4.66667 10.5475 4.9125 10.9851 5.35009C11.4227 5.78767 11.6685 6.38117 11.6685 7.00001V7.00001Z"
      fill="#1ABCFE"
    />
  </svg>
`;

const errorResponse = (res) => {
  res.statusCode = 400;
  res.json({
    isError: true,
  });
};

const createBadge = async (key, label, req, res) => {
  const {
    query: { id },
  } = req;

  res.statusCode = 200;

  const url = `https://www.figma.com/api/plugins/${id}/versions?org_id=`;

  let figmaData = {};
  try {
    const figmaReq = await fetch(url);
    figmaData = await figmaReq.json();
  } catch {
    return errorResponse(res);
  }

  if (figmaData.error || !figmaData?.meta?.plugin?.[key]) {
    return errorResponse(res);
  }
  const message = figmaData.meta.plugin[key];

  res.json({
    schemaVersion: 1,
    label,
    labelColor: "#000000",
    color: "success",
    message: message.toString(),
    logoSvg: logo,
  });
};

export default createBadge;
